<!-- 戰鬥競技場主容器 -->
<div class="arena-container" [class.battle-mode]="battleStarted || battleResult">
  <!-- On-chain Toasts Stack -->
  <div class="onchain-toasts">
    <div class="onchain-toast" *ngFor="let t of toasts" [@toastAnim]>
      <span class="toast-text">{{ t.text }}</span>
      <a *ngIf="t.link" [href]="t.link" target="_blank" rel="noopener" class="toast-link">VIEW</a>
    </div>
  </div>
  <!-- 競技場背景 -->
  <div class="arena-background">
    <div class="magical-atmosphere">
      <div class="energy-orb orb-1"></div>
      <div class="energy-orb orb-2"></div>
      <div class="energy-orb orb-3"></div>
      <div class="energy-orb orb-4"></div>
    </div>
    <div class="arena-floor"></div>
  </div>

  <!-- 響應式頂部狀態列 -->
  <div *ngIf="playerCharacter && opponent" class="battle-hud">
    <!-- 桌面版：橫向佈局 -->
    <div class="desktop-layout">
      <div class="champion-info left">
        <div class="champion-portrait">
          <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name">
          <div class="portrait-frame player"></div>
        </div>
        <div class="champion-details">
          <h3 class="champion-name">{{ playerCharacter.name }}</h3>
          <div class="health-container">
            <div class="health-bar player">
              <div class="health-fill" [style.width.%]="getHealthPercent(playerHealth)"></div>
              <div class="health-text">{{ playerHealth }}/{{ maxHp }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="battle-center">
        <div class="versus-display">
          <div class="vs-icon">⚔</div>
          <div class="battle-timer" *ngIf="battleStarted && !battleResult">
            <div class="timer-ring"></div>
          </div>
        </div>
      </div>

      <div class="champion-info right">
        <div class="champion-details">
          <h3 class="champion-name">{{ opponent.name }}</h3>
          <div class="health-container">
            <div class="health-bar opponent">
              <div class="health-fill" [style.width.%]="getHealthPercent(opponentHealth)"></div>
              <div class="health-text">{{ opponentHealth }}/{{ maxHp }}</div>
            </div>
          </div>
        </div>
        <div class="champion-portrait">
          <img [src]="opponent.image_url | mediaUrl" [alt]="opponent.name">
          <div class="portrait-frame opponent"></div>
        </div>
      </div>
    </div>

    <!-- 手機版：緊湊卡片佈局 -->
    <div class="mobile-layout">
      <div class="battle-status-card">
        <div class="fighter-card player-card">
          <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name" class="fighter-avatar">
          <div class="fighter-info">
            <div class="fighter-name">{{ playerCharacter.name }}</div>
            <div class="health-bar-mobile player">
              <div class="health-fill-mobile" [style.width.%]="getHealthPercent(playerHealth)"></div>
            </div>
            <div class="health-value">{{ playerHealth }}/{{ maxHp }}</div>
          </div>
        </div>
        
        <div class="vs-divider">
          <div class="vs-icon-mobile">VS</div>
        </div>
        
        <div class="fighter-card opponent-card">
          <div class="fighter-info">
            <div class="fighter-name">{{ opponent.name }}</div>
            <div class="health-bar-mobile opponent">
              <div class="health-fill-mobile" [style.width.%]="getHealthPercent(opponentHealth)"></div>
            </div>
            <div class="health-value">{{ opponentHealth }}/{{ maxHp }}</div>
          </div>
          <img [src]="opponent.image_url | mediaUrl" [alt]="opponent.name" class="fighter-avatar">
        </div>
      </div>
    </div>
  </div>

  <!-- 主要戰鬥區域 -->
  <div class="main-arena">
    <!-- 沒有角色狀態 -->
    <div *ngIf="!playerCharacter" class="arena-message">
      <div class="message-portal">
        <div class="portal-rings">
          <div class="ring ring-1"></div>
          <div class="ring ring-2"></div>
          <div class="ring ring-3"></div>
        </div>
        <div class="portal-center">
          <div class="portal-icon">⭐</div>
        </div>
      </div>
      <h2 class="message-title">召喚你的英雄</h2>
      <p class="message-text">競技場等待著真正的戰士！</p>
      <a routerLink="/create" class="arena-button primary">
        <span class="button-icon">✨</span>
        前往召喚
      </a>
    </div>

    <!-- 尋找對手狀態 -->
    <div *ngIf="playerCharacter && !opponent && !battleResult" class="arena-message">
      <div class="message-portal searching">
        <div class="portal-rings">
          <div class="ring ring-1 searching"></div>
          <div class="ring ring-2 searching"></div>
          <div class="ring ring-3 searching"></div>
        </div>
        <div class="portal-center">
          <div class="portal-icon">⚔</div>
        </div>
      </div>
      <h2 class="message-title">尋找對手中...</h2>
      <p class="message-text">正在競技場中搜尋強大的挑戰者</p>
      <button (click)="findNewOpponent()" class="arena-button primary" [disabled]="isLoading">
        <span *ngIf="!isLoading" class="button-icon">🎯</span>
        <span *ngIf="isLoading" class="button-icon loading">⚡</span>
        {{ isLoading ? '搜尋中...' : '尋找對手' }}
      </button>
    </div>

    <!-- 戰鬥場景 - 響應式佈局 -->
    <div *ngIf="playerCharacter && opponent" class="battle-field">
      <!-- 桌面版：三欄佈局 -->
      <div class="desktop-battle-layout">
        <!-- 玩家戰士 -->
        <div class="warrior player-warrior" [class.combat-stance]="battleStarted" [class.hit-impact]="isPlayerBeingAttacked" [class.defeated]="isBattleLogComplete && battleResult && battleResult.winner.id !== playerCharacter.id">
          <div class="warrior-platform">
            <div class="platform-glow player"></div>
          </div>
          <div class="warrior-container">
            <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name" class="warrior-image">
            <div class="warrior-aura player"></div>
            <div class="warrior-stats">
              <div class="stat-item">
                <span class="stat-icon strength">💪</span>
                <span>{{ playerCharacter.strength }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon agility">⚡</span>
                <span>{{ playerCharacter.agility }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon luck">🍀</span>
                <span>{{ playerCharacter.luck }}</span>
              </div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== playerCharacter.id" class="defeat-effect">
              <div class="defeat-symbol">💀</div>
              <div class="defeat-text">戰敗</div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id === playerCharacter.id" class="victory-effect">
              <div class="victory-symbol">👑</div>
              <div class="victory-text">勝利</div>
            </div>
          </div>
        </div>

        <!-- 戰鬥日誌區域 -->
        <div class="combat-log-area">
          <div class="log-container" *ngIf="battleResult; else preBattleLog">
            <div class="log-header">
              <h3 class="log-title">戰鬥實況</h3>
            </div>
            
            <div class="battle-narrative" *ngIf="battleResult.battle_log.battle_description">
              <div class="narrative-icon">📜</div>
              <p class="narrative-text">{{ battleResult.battle_log.battle_description }}</p>
            </div>
            
            <div class="log-entries">
              <div *ngFor="let log of battleResult.battle_log.battle_log; let i = index"
                   class="log-entry"
                   [ngClass]="log.type"
                   [class.visible]="i < currentRound">
                <div class="log-indicator">
                  <span class="log-icon" [ngSwitch]="log.type">
                    <span *ngSwitchCase="'attack'">⚔️</span>
                    <span *ngSwitchCase="'defense'">🛡️</span>
                    <span *ngSwitchCase="'critical'">💥</span>
                    <span *ngSwitchDefault>ℹ️</span>
                  </span>
                </div>
                <div class="log-content">
                  <p class="log-text">{{ log.description }}</p>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #preBattleLog>
            <div class="pre-battle-display">
              <div class="countdown-circle">
                <div class="countdown-inner">
                  <div class="countdown-icon">⚔</div>
                </div>
              </div>
              <h3 class="countdown-text">準備戰鬥</h3>
            </div>
          </ng-template>
        </div>

        <!-- 對手戰士 -->
        <div class="warrior opponent-warrior" [class.combat-stance]="battleStarted" [class.hit-impact]="isOpponentBeingAttacked" [class.defeated]="isBattleLogComplete && battleResult && battleResult.winner.id !== opponent.id">
          <div class="warrior-platform">
            <div class="platform-glow opponent"></div>
          </div>
          <div class="warrior-container">
            <img [src]="opponent.image_url || null | mediaUrl" [alt]="opponent.name || ''" class="warrior-image flipped">
            <div class="warrior-aura opponent"></div>
            <div class="warrior-stats">
              <div class="stat-item">
                <span class="stat-icon strength">💪</span>
                <span>{{ opponent.strength }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon agility">⚡</span>
                <span>{{ opponent.agility }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon luck">🍀</span>
                <span>{{ opponent.luck }}</span>
              </div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== opponent.id" class="defeat-effect">
              <div class="defeat-symbol">💀</div>
              <div class="defeat-text">戰敗</div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id === opponent.id" class="victory-effect">
              <div class="victory-symbol">👑</div>
              <div class="victory-text">勝利</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 手機版：垂直卡片佈局 -->
      <div class="mobile-battle-layout">
        <!-- 戰鬥角色展示區 -->
        <div class="mobile-fighters">
          <div class="mobile-fighter player-side">
            <div class="mobile-warrior-card" [class.attacking]="isPlayerAttacking" [class.hit]="isPlayerBeingAttacked">
              <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name" class="mobile-warrior-image">
              <div class="mobile-warrior-stats">
                <div class="mobile-stat">💪{{ playerCharacter.strength }}</div>
                <div class="mobile-stat">⚡{{ playerCharacter.agility }}</div>
                <div class="mobile-stat">🍀{{ playerCharacter.luck }}</div>
              </div>
            </div>
          </div>
          
          <div class="mobile-vs-section">
            <div class="mobile-vs-icon" [class.battle-active]="battleStarted">⚔</div>
          </div>
          
          <div class="mobile-fighter opponent-side">
            <div class="mobile-warrior-card" [class.attacking]="isOpponentAttacking" [class.hit]="isOpponentBeingAttacked">
              <img [src]="opponent.image_url | mediaUrl" [alt]="opponent.name" class="mobile-warrior-image">
              <div class="mobile-warrior-stats">
                <div class="mobile-stat">💪{{ opponent.strength }}</div>
                <div class="mobile-stat">⚡{{ opponent.agility }}</div>
                <div class="mobile-stat">🍀{{ opponent.luck }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 手機版戰鬥日誌 -->
        <div class="mobile-battle-log">
          <div *ngIf="battleResult; else mobilePrebattle" class="mobile-log-content">
            <div class="mobile-log-header">戰鬥記錄</div>
            <div class="mobile-log-entries">
              <div *ngFor="let log of battleResult.battle_log.battle_log; let i = index"
                   class="mobile-log-entry"
                   [class.visible]="i < currentRound">
                {{ log.description }}
              </div>
            </div>
          </div>
          <ng-template #mobilePrebattle>
            <div class="mobile-waiting">
              <div class="mobile-waiting-icon">⚔</div>
              <div class="mobile-waiting-text">準備戰鬥</div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- 體力不足錯誤提示 -->
  <div *ngIf="energyError" class="energy-error-banner">
    <div class="error-content">
      <div class="error-icon">⚡</div>
      <p class="error-message">{{ energyError }}</p>
      <button (click)="energyError = null" class="close-error">✕</button>
    </div>
  </div>

  <!-- 優化後的戰鬥控制按鈕 -->
  <ng-container *ngIf="playerCharacter && opponent && !battleStarted && !battleResult">
    <div class="battle-controls-new pre-battle">
      <div class="control-panel-new">
        <button (click)="startBattle()" class="battle-btn primary" [disabled]="isLoading">
          <div class="btn-content">
            <span class="btn-icon">⚔</span>
            <span class="btn-text">發起決鬥</span>
          </div>
        </button>
        <button (click)="findNewOpponent()" class="battle-btn secondary" [disabled]="isLoading">
          <div class="btn-content">
            <span class="btn-icon">🔄</span>
            <span class="btn-text">更換對手</span>
          </div>
        </button>
      </div>
    </div>
  </ng-container>
  
  <ng-container *ngIf="battleResult && !showResultOverlay">
    <div class="battle-controls-new post-battle">
      <div class="control-panel-new single">
        <button (click)="resetBattle()" class="battle-btn primary">
          <div class="btn-content">
            <span class="btn-icon">🎯</span>
            <span class="btn-text">再戰一場</span>
          </div>
        </button>
      </div>
    </div>
  </ng-container>

  <!-- 戰鬥進行中覆蓋層 -->
  <div *ngIf="battleStarted && !battleResult" class="battle-progress-overlay">
    <!-- 戰鬥舞台 -->
    <div class="battle-stage">
      <div class="fighting-warriors">
        <!-- 玩家角色 -->
        <div class="fighting-character player" [class.attacking]="isPlayerAttacking">
          <div class="character-battle-card">
            <img [src]="playerCharacter?.image_url || null | mediaUrl" [alt]="playerCharacter?.name || ''" class="battle-char-image">
            <div class="battle-aura player"></div>
            <div class="impact-effect" *ngIf="isPlayerAttacking"></div>
          </div>
        </div>
        
        <!-- 戰鬥中心效果區域 -->
        <div class="battle-center-effect">
          <div class="collision-zone">
            <!-- 多層碰撞波紋 -->
            <div class="collision-wave wave-1"></div>
            <div class="collision-wave wave-2"></div>
            <div class="collision-wave wave-3"></div>
            
            <!-- 能量碎片 -->
            <div class="energy-fragments">
              <div class="fragment fragment-1"></div>
              <div class="fragment fragment-2"></div>
              <div class="fragment fragment-3"></div>
              <div class="fragment fragment-4"></div>
              <div class="fragment fragment-5"></div>
              <div class="fragment fragment-6"></div>
              <div class="fragment fragment-7"></div>
              <div class="fragment fragment-8"></div>
            </div>
            
            <!-- 電光效果 -->
            <div class="lightning-effects">
              <div class="lightning lightning-1"></div>
              <div class="lightning lightning-2"></div>
              <div class="lightning lightning-3"></div>
            </div>
            
            <!-- 中心衝擊 -->
            <div class="core-impact"></div>
          </div>
        </div>
        
        <!-- 對手角色 -->
        <div class="fighting-character opponent" [class.attacking]="isOpponentAttacking">
          <div class="character-battle-card">
            <img [src]="opponent?.image_url || null | mediaUrl" [alt]="opponent?.name || ''" class="battle-char-image flipped">
            <div class="battle-aura opponent"></div>
            <div class="impact-effect" *ngIf="isOpponentAttacking"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 戰鬥狀態 -->
    <div class="battle-status">
      <h2 class="battle-phase">{{ currentBattlePhase }}</h2>
      <p class="battle-description">{{ currentBattleDescription }}</p>
    </div>
    
    <!-- 戰鬥進度 -->
    <div class="battle-progress">
      <div class="progress-step" [class.active]="battleProgressStep >= 1" [class.completed]="battleProgressStep > 1">
        <span>⚔</span>
      </div>
      <div class="progress-line" [class.active]="battleProgressStep >= 2"></div>
      <div class="progress-step" [class.active]="battleProgressStep >= 2" [class.completed]="battleProgressStep > 2">
        <span>⚡</span>
      </div>
      <div class="progress-line" [class.active]="battleProgressStep >= 3"></div>
      <div class="progress-step" [class.active]="battleProgressStep >= 3" [class.completed]="battleProgressStep > 3">
        <span>👑</span>
      </div>
    </div>
  </div>

  <!-- 戰鬥結果覆蓋層 -->
  <div *ngIf="battleResult && showResultOverlay" class="result-overlay" [@fadeInOut]>
    <div class="result-content" [class.victory-theme]="battleResult.winner.id === playerCharacter?.id" [class.defeat-theme]="battleResult.winner.id !== playerCharacter?.id">
      
      <div class="result-header">
        <h1 class="result-title">
          {{ battleResult.winner.id === playerCharacter?.id ? '戰鬥勝利' : '戰鬥失敗' }}
        </h1>
        
        <p class="result-message">
          {{ battleResult.winner.id === playerCharacter?.id ? '獲得勝利！' : '再接再厲' }}
        </p>
      </div>
      
      <div class="result-stats">
        <div class="stat-item">
          <span class="stat-label">勝者</span>
          <span class="stat-value">{{ battleResult.winner.name }}</span>
        </div>
      </div>
      
      <!-- 戰鬥獎勵顯示 -->
      <div *ngIf="showRewards && battleRewards" class="battle-rewards">
        <div class="rewards-header">
          <h3 class="rewards-title">獲得獎勵</h3>
        </div>
        <div class="rewards-list">
          <div class="reward-item" *ngIf="battleRewards.gold > 0">
            <div style="display: flex; align-items: center;">
              <span class="reward-icon">💰</span>
              <span class="reward-label">金幣</span>
            </div>
            <span class="reward-amount">+{{ battleRewards.gold }}</span>
          </div>
          <div class="reward-item" *ngIf="battleRewards.exp_potion > 0">
            <div style="display: flex; align-items: center;">
              <span class="reward-icon">🧪</span>
              <span class="reward-label">經驗藥水</span>
            </div>
            <span class="reward-amount">+{{ battleRewards.exp_potion }}</span>
          </div>
          <div class="bonus-multiplier" *ngIf="battleRewards.rarity_bonus > 1">
            <span class="bonus-text">稀有度加成 ×{{ battleRewards.rarity_bonus }}</span>
          </div>
        </div>
      </div>
      
      <div class="result-actions-new">
        <button (click)="resetBattle()" class="result-btn primary">
          <div class="result-btn-content">
            <span class="result-btn-icon">🎯</span>
            <span class="result-btn-text">再戰一場</span>
          </div>
        </button>
        <button (click)="showResultOverlay = false" class="result-btn secondary">
          <div class="result-btn-content">
            <span class="result-btn-icon">📊</span>
            <span class="result-btn-text">查看戰報</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>