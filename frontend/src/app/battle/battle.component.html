<!-- Main Battle Container -->
<div class="battle-container" [class.battle-active]="battleStarted">
  <!-- Background Scenery -->
  <div class="battle-background"></div>

  <!-- No Character Message -->
  <div *ngIf="!playerCharacter" class="message-card-container">
    <div class="message-card">
      <div class="message-icon">ğŸ­</div>
      <h2 class="message-title">å°šæœªé¸æ“‡è§’è‰²</h2>
      <p class="message-text">ä½ éœ€è¦ä¸€å€‹è‹±é›„æ‰èƒ½è¸å…¥æˆ°å ´ï¼</p>
      <a routerLink="/create" class="action-button primary">å‰å¾€å‰µå»º</a>
    </div>
  </div>

  <!-- Opponent Search Message -->
  <div *ngIf="playerCharacter && !opponent && !battleResult" class="message-card-container">
    <div class="message-card">
      <div class="message-icon animate-pulse">âš”ï¸</div>
      <h2 class="message-title">æº–å‚™å¥½æˆ°é¬¥äº†å—ï¼Ÿ</h2>
      <p class="message-text">é€²å…¥ç«¶æŠ€å ´ï¼Œå°‹æ‰¾ä¸€å€‹å€¼å¾—ä¸€æˆ°çš„å°æ‰‹ã€‚</p>
      <button (click)="findNewOpponent()" class="action-button primary" [disabled]="isLoading">
        <span *ngIf="!isLoading">å°‹æ‰¾å°æ‰‹</span>
        <span *ngIf="isLoading" class="animate-spin">â³</span>
      </button>
    </div>
  </div>

  <!-- Main Battle Scene -->
  <div *ngIf="playerCharacter && opponent" class="battle-scene-grid flex flex-col">
    <!-- Player Arena -->
    <div class="arena-side player-side">
      <div class="hero-card" [class.is-hit]="isPlayerBeingAttacked">
        <div class="hero-image-container">
          <img class="hero-image" [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name">
        </div>
        <div class="hero-info">
          <h3 class="hero-name">{{ playerCharacter.name }}</h3>
          <div class="hp-bar-container">
            <div class="hp-bar" [style.width.%]="playerHealth"></div>
            <span class="hp-text">{{ playerHealth }} / 100</span>
          </div>
        </div>
        <!-- Player Defeat Overlay -->
        <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== playerCharacter.id" class="defeat-overlay">
          <div class="defeat-icon">ğŸ’€</div>
          <h3 class="defeat-text">æˆ°æ•—</h3>
        </div>
      </div>
    </div>

    <!-- Center Column: Log & Controls -->
    <div class="arena-center">
      <div class="battle-log-container">
        <div *ngIf="battleResult; else preBattle" class="battle-log">
          <!-- é¡¯ç¤ºæˆ°é¬¥æè¿°ï¼ˆAIç”Ÿæˆçš„èƒŒæ™¯èˆ‡ç¸½çµï¼‰ -->
          <div *ngIf="battleResult.battle_log.battle_description" class="battle-description mb-4 p-2 bg-gray-800/60 rounded text-gray-200">
            <span class="font-bold text-rpg-gold">æˆ°é¬¥èƒŒæ™¯ï¼š</span>
            {{ battleResult.battle_log.battle_description }}
          </div>
          <div *ngFor="let log of battleResult.battle_log.battle_log; let i = index"
               class="log-entry"
               [ngClass]="log.type"
               [class.visible]="i < currentRound">
            <div class="log-icon">
              <span *ngIf="log.type === 'attack'">âš”ï¸</span>
              <span *ngIf="log.type === 'defense'">ğŸ›¡ï¸</span>
              <span *ngIf="log.type === 'critical'">ğŸ’¥</span>
              <span *ngIf="log.type === 'info'">â„¹ï¸</span>
            </div>
            <p class="log-text">{{ log.description }}</p>
          </div>
        </div>
        <ng-template #preBattle>
          <div class="pre-battle-status">
            <div class="vs-text">VS</div>
            <p>ç­‰å¾…æˆ°é¬¥é–‹å§‹...</p>
          </div>
        </ng-template>
      </div>
      
      <div class="battle-controls">
        <ng-container *ngIf="!battleStarted && !battleResult">
          <button (click)="startBattle()" class="action-button primary" [disabled]="isLoading">ç™¼èµ·æŒ‘æˆ°</button>
          <button (click)="findNewOpponent()" class="action-button secondary" [disabled]="isLoading">æ›´æ›å°æ‰‹</button>
        </ng-container>
        <!-- This button now shows up after the battle is completely over -->
        <ng-container *ngIf="battleResult && !showResultOverlay">
           <button (click)="resetBattle()" class="action-button primary">å†ä¾†ä¸€å±€</button>
        </ng-container>
      </div>
    </div>

    <!-- Opponent Arena -->
    <div class="arena-side opponent-side">
       <div class="hero-card" [class.is-hit]="isOpponentBeingAttacked">
        <div class="hero-image-container">
          <img class="hero-image" [src]="opponent.image_url | mediaUrl" [alt]="opponent.name">
        </div>
        <div class="hero-info">
          <h3 class="hero-name">{{ opponent.name }}</h3>
          <div class="hp-bar-container">
            <div class="hp-bar" [style.width.%]="opponentHealth"></div>
             <span class="hp-text">{{ opponentHealth }} / 100</span>
          </div>
        </div>
        <!-- Opponent Defeat Overlay -->
        <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== opponent.id" class="defeat-overlay">
          <div class="defeat-icon">ğŸ’€</div>
          <h3 class="defeat-text">æˆ°æ•—</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Battle In-Progress Overlay -->
  <div *ngIf="battleStarted && !battleResult" class="battle-in-progress-overlay">
    <div class="spinner">âš”ï¸</div>
    <p>AI æ­£åœ¨ä¸»å°æˆ°é¬¥...</p>
  </div>

  <!-- Battle Result Overlay -->
  <div *ngIf="battleResult && showResultOverlay" class="result-overlay" [@fadeInOut]>
    <div class="result-card" [class.victory]="battleResult.winner.id === playerCharacter?.id" [class.defeat]="battleResult.winner.id !== playerCharacter?.id">
      <div class="result-icon">
        {{ battleResult.winner.id === playerCharacter?.id ? 'ğŸ†' : 'ğŸ’€' }}
      </div>
      <h2 class="result-title">
        {{ battleResult.winner.id === playerCharacter?.id ? 'å…‰æ¦®å‹åˆ©' : 'æƒœæ•—' }}
      </h2>
      <p class="result-message">
        {{ battleResult.winner.id === playerCharacter?.id ? 'ä½ çš„è‹±é›„æŠ€å£“ç¾¤é›„ï¼' : 'è‹±é›„é›–æ•—çŒ¶æ¦®ï¼Œé‡æ•´æ——é¼“å†ä¾†ï¼' }}
      </p>
      <div class="result-actions">
        <button (click)="resetBattle()" class="action-button primary">å†ä¾†ä¸€å±€</button>
        <button (click)="showResultOverlay = false" class="action-button secondary">æŸ¥çœ‹æˆ°å ±</button>
      </div>
    </div>
  </div>
</div> 