<!-- æˆ°é¬¥ç«¶æŠ€å ´ä¸»å®¹å™¨ -->
<div class="arena-container" [class.battle-mode]="battleStarted || battleResult">
  <!-- On-chain Toasts Stack -->
  <div class="onchain-toasts">
    <div class="onchain-toast" *ngFor="let t of toasts" [@toastAnim]>
      <span class="toast-text">{{ t.text }}</span>
      <a *ngIf="t.link" [href]="t.link" target="_blank" rel="noopener" class="toast-link">VIEW</a>
    </div>
  </div>
  <!-- ç«¶æŠ€å ´èƒŒæ™¯ -->
  <div class="arena-background">
    <div class="magical-atmosphere">
      <div class="energy-orb orb-1"></div>
      <div class="energy-orb orb-2"></div>
      <div class="energy-orb orb-3"></div>
      <div class="energy-orb orb-4"></div>
    </div>
    <div class="arena-floor"></div>
  </div>

  <!-- éŸ¿æ‡‰å¼é ‚éƒ¨ç‹€æ…‹åˆ— -->
  <div *ngIf="playerCharacter && opponent" class="battle-hud">
    <!-- æ¡Œé¢ç‰ˆï¼šæ©«å‘ä½ˆå±€ -->
    <div class="desktop-layout">
      <div class="champion-info left">
        <div class="champion-portrait">
          <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name">
          <div class="portrait-frame player"></div>
        </div>
        <div class="champion-details">
          <h3 class="champion-name">{{ playerCharacter.name }}</h3>
          <div class="health-container">
            <div class="health-bar player">
              <div class="health-fill" [style.width.%]="getHealthPercent(playerHealth)"></div>
              <div class="health-text">{{ playerHealth }}/{{ maxHp }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="battle-center">
        <div class="versus-display">
          <div class="vs-icon">âš”</div>
          <div class="battle-timer" *ngIf="battleStarted && !battleResult">
            <div class="timer-ring"></div>
          </div>
        </div>
      </div>

      <div class="champion-info right">
        <div class="champion-details">
          <h3 class="champion-name">{{ opponent.name }}</h3>
          <div class="health-container">
            <div class="health-bar opponent">
              <div class="health-fill" [style.width.%]="getHealthPercent(opponentHealth)"></div>
              <div class="health-text">{{ opponentHealth }}/{{ maxHp }}</div>
            </div>
          </div>
        </div>
        <div class="champion-portrait">
          <img [src]="opponent.image_url | mediaUrl" [alt]="opponent.name">
          <div class="portrait-frame opponent"></div>
        </div>
      </div>
    </div>

    <!-- æ‰‹æ©Ÿç‰ˆï¼šç·Šæ¹Šå¡ç‰‡ä½ˆå±€ -->
    <div class="mobile-layout">
      <div class="battle-status-card">
        <div class="fighter-card player-card">
          <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name" class="fighter-avatar">
          <div class="fighter-info">
            <div class="fighter-name">{{ playerCharacter.name }}</div>
            <div class="health-bar-mobile player">
              <div class="health-fill-mobile" [style.width.%]="getHealthPercent(playerHealth)"></div>
            </div>
            <div class="health-value">{{ playerHealth }}/{{ maxHp }}</div>
          </div>
        </div>
        
        <div class="vs-divider">
          <div class="vs-icon-mobile">VS</div>
        </div>
        
        <div class="fighter-card opponent-card">
          <div class="fighter-info">
            <div class="fighter-name">{{ opponent.name }}</div>
            <div class="health-bar-mobile opponent">
              <div class="health-fill-mobile" [style.width.%]="getHealthPercent(opponentHealth)"></div>
            </div>
            <div class="health-value">{{ opponentHealth }}/{{ maxHp }}</div>
          </div>
          <img [src]="opponent.image_url | mediaUrl" [alt]="opponent.name" class="fighter-avatar">
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»è¦æˆ°é¬¥å€åŸŸ -->
  <div class="main-arena">
    <!-- æ²’æœ‰è§’è‰²ç‹€æ…‹ -->
    <div *ngIf="!playerCharacter" class="arena-message">
      <div class="message-portal">
        <div class="portal-rings">
          <div class="ring ring-1"></div>
          <div class="ring ring-2"></div>
          <div class="ring ring-3"></div>
        </div>
        <div class="portal-center">
          <div class="portal-icon">â­</div>
        </div>
      </div>
      <h2 class="message-title">å¬å–šä½ çš„è‹±é›„</h2>
      <p class="message-text">ç«¶æŠ€å ´ç­‰å¾…è‘—çœŸæ­£çš„æˆ°å£«ï¼</p>
      <a routerLink="/create" class="arena-button primary">
        <span class="button-icon">âœ¨</span>
        å‰å¾€å¬å–š
      </a>
    </div>

    <!-- å°‹æ‰¾å°æ‰‹ç‹€æ…‹ -->
    <div *ngIf="playerCharacter && !opponent && !battleResult" class="arena-message">
      <div class="message-portal searching">
        <div class="portal-rings">
          <div class="ring ring-1 searching"></div>
          <div class="ring ring-2 searching"></div>
          <div class="ring ring-3 searching"></div>
        </div>
        <div class="portal-center">
          <div class="portal-icon">âš”</div>
        </div>
      </div>
      <h2 class="message-title">å°‹æ‰¾å°æ‰‹ä¸­...</h2>
      <p class="message-text">æ­£åœ¨ç«¶æŠ€å ´ä¸­æœå°‹å¼·å¤§çš„æŒ‘æˆ°è€…</p>
      <button (click)="findNewOpponent()" class="arena-button primary" [disabled]="isLoading">
        <span *ngIf="!isLoading" class="button-icon">ğŸ¯</span>
        <span *ngIf="isLoading" class="button-icon loading">âš¡</span>
        {{ isLoading ? 'æœå°‹ä¸­...' : 'å°‹æ‰¾å°æ‰‹' }}
      </button>
    </div>

    <!-- æˆ°é¬¥å ´æ™¯ - éŸ¿æ‡‰å¼ä½ˆå±€ -->
    <div *ngIf="playerCharacter && opponent" class="battle-field">
      <!-- æ¡Œé¢ç‰ˆï¼šä¸‰æ¬„ä½ˆå±€ -->
      <div class="desktop-battle-layout">
        <!-- ç©å®¶æˆ°å£« -->
        <div class="warrior player-warrior" [class.combat-stance]="battleStarted" [class.hit-impact]="isPlayerBeingAttacked" [class.defeated]="isBattleLogComplete && battleResult && battleResult.winner.id !== playerCharacter.id">
          <div class="warrior-platform">
            <div class="platform-glow player"></div>
          </div>
          <div class="warrior-container">
            <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name" class="warrior-image">
            <div class="warrior-aura player"></div>
            <div class="warrior-stats">
              <div class="stat-item">
                <span class="stat-icon strength">ğŸ’ª</span>
                <span>{{ playerCharacter.strength }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon agility">âš¡</span>
                <span>{{ playerCharacter.agility }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon luck">ğŸ€</span>
                <span>{{ playerCharacter.luck }}</span>
              </div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== playerCharacter.id" class="defeat-effect">
              <div class="defeat-symbol">ğŸ’€</div>
              <div class="defeat-text">æˆ°æ•—</div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id === playerCharacter.id" class="victory-effect">
              <div class="victory-symbol">ğŸ‘‘</div>
              <div class="victory-text">å‹åˆ©</div>
            </div>
          </div>
        </div>

        <!-- æˆ°é¬¥æ—¥èªŒå€åŸŸ -->
        <div class="combat-log-area">
          <div class="log-container" *ngIf="battleResult; else preBattleLog">
            <div class="log-header">
              <h3 class="log-title">æˆ°é¬¥å¯¦æ³</h3>
            </div>
            
            <div class="battle-narrative" *ngIf="battleResult.battle_log.battle_description">
              <div class="narrative-icon">ğŸ“œ</div>
              <p class="narrative-text">{{ battleResult.battle_log.battle_description }}</p>
            </div>
            
            <div class="log-entries">
              <div *ngFor="let log of battleResult.battle_log.battle_log; let i = index"
                   class="log-entry"
                   [ngClass]="log.type"
                   [class.visible]="i < currentRound">
                <div class="log-indicator">
                  <span class="log-icon" [ngSwitch]="log.type">
                    <span *ngSwitchCase="'attack'">âš”ï¸</span>
                    <span *ngSwitchCase="'defense'">ğŸ›¡ï¸</span>
                    <span *ngSwitchCase="'critical'">ğŸ’¥</span>
                    <span *ngSwitchDefault>â„¹ï¸</span>
                  </span>
                </div>
                <div class="log-content">
                  <p class="log-text">{{ log.description }}</p>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #preBattleLog>
            <div class="pre-battle-display">
              <div class="countdown-circle">
                <div class="countdown-inner">
                  <div class="countdown-icon">âš”</div>
                </div>
              </div>
              <h3 class="countdown-text">æº–å‚™æˆ°é¬¥</h3>
            </div>
          </ng-template>
        </div>

        <!-- å°æ‰‹æˆ°å£« -->
        <div class="warrior opponent-warrior" [class.combat-stance]="battleStarted" [class.hit-impact]="isOpponentBeingAttacked" [class.defeated]="isBattleLogComplete && battleResult && battleResult.winner.id !== opponent.id">
          <div class="warrior-platform">
            <div class="platform-glow opponent"></div>
          </div>
          <div class="warrior-container">
            <img [src]="opponent.image_url || null | mediaUrl" [alt]="opponent.name || ''" class="warrior-image flipped">
            <div class="warrior-aura opponent"></div>
            <div class="warrior-stats">
              <div class="stat-item">
                <span class="stat-icon strength">ğŸ’ª</span>
                <span>{{ opponent.strength }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon agility">âš¡</span>
                <span>{{ opponent.agility }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-icon luck">ğŸ€</span>
                <span>{{ opponent.luck }}</span>
              </div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== opponent.id" class="defeat-effect">
              <div class="defeat-symbol">ğŸ’€</div>
              <div class="defeat-text">æˆ°æ•—</div>
            </div>
            <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id === opponent.id" class="victory-effect">
              <div class="victory-symbol">ğŸ‘‘</div>
              <div class="victory-text">å‹åˆ©</div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ‰‹æ©Ÿç‰ˆï¼šå‚ç›´å¡ç‰‡ä½ˆå±€ -->
      <div class="mobile-battle-layout">
        <!-- æˆ°é¬¥è§’è‰²å±•ç¤ºå€ -->
        <div class="mobile-fighters">
          <div class="mobile-fighter player-side">
            <div class="mobile-warrior-card" [class.attacking]="isPlayerAttacking" [class.hit]="isPlayerBeingAttacked">
              <img [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name" class="mobile-warrior-image">
              <div class="mobile-warrior-stats">
                <div class="mobile-stat">ğŸ’ª{{ playerCharacter.strength }}</div>
                <div class="mobile-stat">âš¡{{ playerCharacter.agility }}</div>
                <div class="mobile-stat">ğŸ€{{ playerCharacter.luck }}</div>
              </div>
            </div>
          </div>
          
          <div class="mobile-vs-section">
            <div class="mobile-vs-icon" [class.battle-active]="battleStarted">âš”</div>
          </div>
          
          <div class="mobile-fighter opponent-side">
            <div class="mobile-warrior-card" [class.attacking]="isOpponentAttacking" [class.hit]="isOpponentBeingAttacked">
              <img [src]="opponent.image_url | mediaUrl" [alt]="opponent.name" class="mobile-warrior-image">
              <div class="mobile-warrior-stats">
                <div class="mobile-stat">ğŸ’ª{{ opponent.strength }}</div>
                <div class="mobile-stat">âš¡{{ opponent.agility }}</div>
                <div class="mobile-stat">ğŸ€{{ opponent.luck }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆæˆ°é¬¥æ—¥èªŒ -->
        <div class="mobile-battle-log">
          <div *ngIf="battleResult; else mobilePrebattle" class="mobile-log-content">
            <div class="mobile-log-header">æˆ°é¬¥è¨˜éŒ„</div>
            <div class="mobile-log-entries">
              <div *ngFor="let log of battleResult.battle_log.battle_log; let i = index"
                   class="mobile-log-entry"
                   [class.visible]="i < currentRound">
                {{ log.description }}
              </div>
            </div>
          </div>
          <ng-template #mobilePrebattle>
            <div class="mobile-waiting">
              <div class="mobile-waiting-icon">âš”</div>
              <div class="mobile-waiting-text">æº–å‚™æˆ°é¬¥</div>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- é«”åŠ›ä¸è¶³éŒ¯èª¤æç¤º -->
  <div *ngIf="energyError" class="energy-error-banner">
    <div class="error-content">
      <div class="error-icon">âš¡</div>
      <p class="error-message">{{ energyError }}</p>
      <button (click)="energyError = null" class="close-error">âœ•</button>
    </div>
  </div>

  <!-- å„ªåŒ–å¾Œçš„æˆ°é¬¥æ§åˆ¶æŒ‰éˆ• -->
  <ng-container *ngIf="playerCharacter && opponent && !battleStarted && !battleResult">
    <div class="battle-controls-new pre-battle">
      <div class="control-panel-new">
        <button (click)="startBattle()" class="battle-btn primary" [disabled]="isLoading">
          <div class="btn-content">
            <span class="btn-icon">âš”</span>
            <span class="btn-text">ç™¼èµ·æ±ºé¬¥</span>
          </div>
        </button>
        <button (click)="findNewOpponent()" class="battle-btn secondary" [disabled]="isLoading">
          <div class="btn-content">
            <span class="btn-icon">ğŸ”„</span>
            <span class="btn-text">æ›´æ›å°æ‰‹</span>
          </div>
        </button>
      </div>
    </div>
  </ng-container>
  
  <ng-container *ngIf="battleResult && !showResultOverlay">
    <div class="battle-controls-new post-battle">
      <div class="control-panel-new single">
        <button (click)="resetBattle()" class="battle-btn primary">
          <div class="btn-content">
            <span class="btn-icon">ğŸ¯</span>
            <span class="btn-text">å†æˆ°ä¸€å ´</span>
          </div>
        </button>
      </div>
    </div>
  </ng-container>

  <!-- æˆ°é¬¥é€²è¡Œä¸­è¦†è“‹å±¤ -->
  <div *ngIf="battleStarted && !battleResult" class="battle-progress-overlay">
    <!-- æˆ°é¬¥èˆå° -->
    <div class="battle-stage">
      <div class="fighting-warriors">
        <!-- ç©å®¶è§’è‰² -->
        <div class="fighting-character player" [class.attacking]="isPlayerAttacking">
          <div class="character-battle-card">
            <img [src]="playerCharacter?.image_url || null | mediaUrl" [alt]="playerCharacter?.name || ''" class="battle-char-image">
            <div class="battle-aura player"></div>
            <div class="impact-effect" *ngIf="isPlayerAttacking"></div>
          </div>
        </div>
        
        <!-- æˆ°é¬¥ä¸­å¿ƒæ•ˆæœå€åŸŸ -->
        <div class="battle-center-effect">
          <div class="collision-zone">
            <!-- å¤šå±¤ç¢°æ’æ³¢ç´‹ -->
            <div class="collision-wave wave-1"></div>
            <div class="collision-wave wave-2"></div>
            <div class="collision-wave wave-3"></div>
            
            <!-- èƒ½é‡ç¢ç‰‡ -->
            <div class="energy-fragments">
              <div class="fragment fragment-1"></div>
              <div class="fragment fragment-2"></div>
              <div class="fragment fragment-3"></div>
              <div class="fragment fragment-4"></div>
              <div class="fragment fragment-5"></div>
              <div class="fragment fragment-6"></div>
              <div class="fragment fragment-7"></div>
              <div class="fragment fragment-8"></div>
            </div>
            
            <!-- é›»å…‰æ•ˆæœ -->
            <div class="lightning-effects">
              <div class="lightning lightning-1"></div>
              <div class="lightning lightning-2"></div>
              <div class="lightning lightning-3"></div>
            </div>
            
            <!-- ä¸­å¿ƒè¡æ“Š -->
            <div class="core-impact"></div>
          </div>
        </div>
        
        <!-- å°æ‰‹è§’è‰² -->
        <div class="fighting-character opponent" [class.attacking]="isOpponentAttacking">
          <div class="character-battle-card">
            <img [src]="opponent?.image_url || null | mediaUrl" [alt]="opponent?.name || ''" class="battle-char-image flipped">
            <div class="battle-aura opponent"></div>
            <div class="impact-effect" *ngIf="isOpponentAttacking"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æˆ°é¬¥ç‹€æ…‹ -->
    <div class="battle-status">
      <h2 class="battle-phase">{{ currentBattlePhase }}</h2>
      <p class="battle-description">{{ currentBattleDescription }}</p>
    </div>
    
    <!-- æˆ°é¬¥é€²åº¦ -->
    <div class="battle-progress">
      <div class="progress-step" [class.active]="battleProgressStep >= 1" [class.completed]="battleProgressStep > 1">
        <span>âš”</span>
      </div>
      <div class="progress-line" [class.active]="battleProgressStep >= 2"></div>
      <div class="progress-step" [class.active]="battleProgressStep >= 2" [class.completed]="battleProgressStep > 2">
        <span>âš¡</span>
      </div>
      <div class="progress-line" [class.active]="battleProgressStep >= 3"></div>
      <div class="progress-step" [class.active]="battleProgressStep >= 3" [class.completed]="battleProgressStep > 3">
        <span>ğŸ‘‘</span>
      </div>
    </div>
  </div>

  <!-- æˆ°é¬¥çµæœè¦†è“‹å±¤ -->
  <div *ngIf="battleResult && showResultOverlay" class="result-overlay" [@fadeInOut]>
    <div class="result-content" [class.victory-theme]="battleResult.winner.id === playerCharacter?.id" [class.defeat-theme]="battleResult.winner.id !== playerCharacter?.id">
      
      <div class="result-header">
        <h1 class="result-title">
          {{ battleResult.winner.id === playerCharacter?.id ? 'æˆ°é¬¥å‹åˆ©' : 'æˆ°é¬¥å¤±æ•—' }}
        </h1>
        
        <p class="result-message">
          {{ battleResult.winner.id === playerCharacter?.id ? 'ç²å¾—å‹åˆ©ï¼' : 'å†æ¥å†å²' }}
        </p>
      </div>
      
      <div class="result-stats">
        <div class="stat-item">
          <span class="stat-label">å‹è€…</span>
          <span class="stat-value">{{ battleResult.winner.name }}</span>
        </div>
      </div>
      
      <!-- æˆ°é¬¥çå‹µé¡¯ç¤º -->
      <div *ngIf="showRewards && battleRewards" class="battle-rewards">
        <div class="rewards-header">
          <h3 class="rewards-title">ç²å¾—çå‹µ</h3>
        </div>
        <div class="rewards-list">
          <div class="reward-item" *ngIf="battleRewards.gold > 0">
            <div style="display: flex; align-items: center;">
              <span class="reward-icon">ğŸ’°</span>
              <span class="reward-label">é‡‘å¹£</span>
            </div>
            <span class="reward-amount">+{{ battleRewards.gold }}</span>
          </div>
          <div class="reward-item" *ngIf="battleRewards.exp_potion > 0">
            <div style="display: flex; align-items: center;">
              <span class="reward-icon">ğŸ§ª</span>
              <span class="reward-label">ç¶“é©—è—¥æ°´</span>
            </div>
            <span class="reward-amount">+{{ battleRewards.exp_potion }}</span>
          </div>
          <div class="bonus-multiplier" *ngIf="battleRewards.rarity_bonus > 1">
            <span class="bonus-text">ç¨€æœ‰åº¦åŠ æˆ Ã—{{ battleRewards.rarity_bonus }}</span>
          </div>
        </div>
      </div>
      
      <div class="result-actions-new">
        <button (click)="resetBattle()" class="result-btn primary">
          <div class="result-btn-content">
            <span class="result-btn-icon">ğŸ¯</span>
            <span class="result-btn-text">å†æˆ°ä¸€å ´</span>
          </div>
        </button>
        <button (click)="showResultOverlay = false" class="result-btn secondary">
          <div class="result-btn-content">
            <span class="result-btn-icon">ğŸ“Š</span>
            <span class="result-btn-text">æŸ¥çœ‹æˆ°å ±</span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>