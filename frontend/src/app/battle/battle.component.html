<!-- Main Battle Container -->
<div class="battle-container" [class.battle-active]="battleStarted">
  <!-- Background Scenery -->
  <div class="battle-background"></div>

  <!-- No Character Message -->
  <div *ngIf="!playerCharacter" class="message-card-container">
    <div class="message-card">
      <div class="message-icon">🎭</div>
      <h2 class="message-title">尚未選擇角色</h2>
      <p class="message-text">你需要一個英雄才能踏入戰場！</p>
      <a routerLink="/create" class="action-button primary">前往創建</a>
    </div>
  </div>

  <!-- Opponent Search Message -->
  <div *ngIf="playerCharacter && !opponent && !battleResult" class="message-card-container">
    <div class="message-card">
      <div class="message-icon animate-pulse">⚔️</div>
      <h2 class="message-title">準備好戰鬥了嗎？</h2>
      <p class="message-text">進入競技場，尋找一個值得一戰的對手。</p>
      <button (click)="findNewOpponent()" class="action-button primary" [disabled]="isLoading">
        <span *ngIf="!isLoading">尋找對手</span>
        <span *ngIf="isLoading" class="animate-spin">⏳</span>
      </button>
    </div>
  </div>

  <!-- Main Battle Scene -->
  <div *ngIf="playerCharacter && opponent" class="battle-scene-grid flex flex-col">
    <!-- Player Arena -->
    <div class="arena-side player-side">
      <div class="hero-card" [class.is-hit]="isPlayerBeingAttacked">
        <div class="hero-image-container">
          <img class="hero-image" [src]="playerCharacter.image_url | mediaUrl" [alt]="playerCharacter.name">
        </div>
        <div class="hero-info">
          <h3 class="hero-name">{{ playerCharacter.name }}</h3>
          <div class="hp-bar-container">
            <div class="hp-bar" [style.width.%]="playerHealth"></div>
            <span class="hp-text">{{ playerHealth }} / 100</span>
          </div>
        </div>
        <!-- Player Defeat Overlay -->
        <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== playerCharacter.id" class="defeat-overlay">
          <div class="defeat-icon">💀</div>
          <h3 class="defeat-text">戰敗</h3>
        </div>
      </div>
    </div>

    <!-- Center Column: Log & Controls -->
    <div class="arena-center">
      <div class="battle-log-container">
        <div *ngIf="battleResult; else preBattle" class="battle-log">
          <!-- 顯示戰鬥描述（AI生成的背景與總結） -->
          <div *ngIf="battleResult.battle_log.battle_description" class="battle-description mb-4 p-2 bg-gray-800/60 rounded text-gray-200">
            <span class="font-bold text-rpg-gold">戰鬥背景：</span>
            {{ battleResult.battle_log.battle_description }}
          </div>
          <div *ngFor="let log of battleResult.battle_log.battle_log; let i = index"
               class="log-entry"
               [ngClass]="log.type"
               [class.visible]="i < currentRound">
            <div class="log-icon">
              <span *ngIf="log.type === 'attack'">⚔️</span>
              <span *ngIf="log.type === 'defense'">🛡️</span>
              <span *ngIf="log.type === 'critical'">💥</span>
              <span *ngIf="log.type === 'info'">ℹ️</span>
            </div>
            <p class="log-text">{{ log.description }}</p>
          </div>
        </div>
        <ng-template #preBattle>
          <div class="pre-battle-status">
            <div class="vs-text">VS</div>
            <p>等待戰鬥開始...</p>
          </div>
        </ng-template>
      </div>
      
      <div class="battle-controls">
        <ng-container *ngIf="!battleStarted && !battleResult">
          <button (click)="startBattle()" class="action-button primary" [disabled]="isLoading">發起挑戰</button>
          <button (click)="findNewOpponent()" class="action-button secondary" [disabled]="isLoading">更換對手</button>
        </ng-container>
        <!-- This button now shows up after the battle is completely over -->
        <ng-container *ngIf="battleResult && !showResultOverlay">
           <button (click)="resetBattle()" class="action-button primary">再來一局</button>
        </ng-container>
      </div>
    </div>

    <!-- Opponent Arena -->
    <div class="arena-side opponent-side">
       <div class="hero-card" [class.is-hit]="isOpponentBeingAttacked">
        <div class="hero-image-container">
          <img class="hero-image" [src]="opponent.image_url | mediaUrl" [alt]="opponent.name">
        </div>
        <div class="hero-info">
          <h3 class="hero-name">{{ opponent.name }}</h3>
          <div class="hp-bar-container">
            <div class="hp-bar" [style.width.%]="opponentHealth"></div>
             <span class="hp-text">{{ opponentHealth }} / 100</span>
          </div>
        </div>
        <!-- Opponent Defeat Overlay -->
        <div *ngIf="isBattleLogComplete && battleResult && battleResult.winner.id !== opponent.id" class="defeat-overlay">
          <div class="defeat-icon">💀</div>
          <h3 class="defeat-text">戰敗</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Battle In-Progress Overlay -->
  <div *ngIf="battleStarted && !battleResult" class="battle-in-progress-overlay">
    <div class="spinner">⚔️</div>
    <p>AI 正在主導戰鬥...</p>
  </div>

  <!-- Battle Result Overlay -->
  <div *ngIf="battleResult && showResultOverlay" class="result-overlay" [@fadeInOut]>
    <div class="result-card" [class.victory]="battleResult.winner.id === playerCharacter?.id" [class.defeat]="battleResult.winner.id !== playerCharacter?.id">
      <div class="result-icon">
        {{ battleResult.winner.id === playerCharacter?.id ? '🏆' : '💀' }}
      </div>
      <h2 class="result-title">
        {{ battleResult.winner.id === playerCharacter?.id ? '光榮勝利' : '惜敗' }}
      </h2>
      <p class="result-message">
        {{ battleResult.winner.id === playerCharacter?.id ? '你的英雄技壓群雄！' : '英雄雖敗猶榮，重整旗鼓再來！' }}
      </p>
      <div class="result-actions">
        <button (click)="resetBattle()" class="action-button primary">再來一局</button>
        <button (click)="showResultOverlay = false" class="action-button secondary">查看戰報</button>
      </div>
    </div>
  </div>
</div> 