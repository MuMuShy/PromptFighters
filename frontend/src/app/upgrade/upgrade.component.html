<div *ngIf="isLoading" class="loading-overlay">
  <div class="magical-portal">
    <div class="magic-circle">
      <div class="inner-circle"></div>
      <div class="runes">âœ¦ âœ§ âœ¦ âœ§ âœ¦ âœ§</div>
    </div>
    <div class="energy-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
    <div class="overlay-text">
      <span class="text-glow">æ­£åœ¨è¼‰å…¥è§’è‰²å‡ç´šè³‡è¨Š...</span>
    </div>
  </div>
</div>

<div *ngIf="!isLoading && character" class="upgrade-container">
  <div class="upgrade-header">
    <button (click)="goBack()" class="back-button">
      <span>â†</span> è¿”å›è§’è‰²åˆ—è¡¨
    </button>
    <h1 class="upgrade-title">è§’è‰²å‡ç´š</h1>
  </div>

  <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
  <div *ngIf="message" class="message-bar" [ngClass]="messageType">
    <span>{{ message }}</span>
    <button (click)="message = ''" class="close-message">Ã—</button>
  </div>

  <div class="upgrade-content">
    <!-- å·¦å´ï¼šè§’è‰²è³‡è¨Š -->
    <div class="character-info-panel">
      <div class="character-card-large" [ngClass]="'rarity-' + character.rarity">
        <div class="character-header">
          <h2 class="character-name">{{ character.name }}</h2>
          <div class="rarity-badge" [ngClass]="'rarity-' + character.rarity">
            {{ getRarityLabel(character.rarity) }}
          </div>
        </div>
        
        <div class="character-image-section">
          <div class="character-portrait">
            <img 
              *ngIf="!character.image_url.includes('placeholder')" 
              [src]="getFullImageUrl(character.image_url)" 
              [alt]="character.name" 
              class="character-image"
            />
            <div *ngIf="character.image_url.includes('placeholder')" class="image-loading">
              <div class="spinner"></div>
              <div class="loading-text">åœ–ç‰‡ç”Ÿæˆä¸­...</div>
            </div>
          </div>
          
          <div class="level-display">
            <div class="current-level">Lv.{{ character.level }}</div>
            <div class="next-level" *ngIf="!upgradeInfo.is_max_level && expAmount > 0 && levelUpResults.finalLevel > character.level">â†’ Lv.{{ levelUpResults.finalLevel }}</div>
            <div class="max-level-indicator" *ngIf="upgradeInfo.is_max_level">å·²é”æ»¿ç´š</div>
          </div>
          
          <!-- ç¶“é©—å€¼é€²åº¦æ¢ -->
          <div class="exp-bar-container" *ngIf="!upgradeInfo.is_max_level">
            <div class="exp-bar">
              <div class="exp-fill" [style.width.%]="upgradeInfo.experience_progress"></div>
              <div class="exp-fill-preview" *ngIf="expAmount > 0" [style.width.%]="Math.min(100, (upgradeInfo.current_experience + expAmount) / upgradeInfo.required_experience * 100)"></div>
              <div class="exp-text">
                <span *ngIf="expAmount <= 0">{{ upgradeInfo.current_experience }} / {{ upgradeInfo.required_experience }}</span>
                <span *ngIf="expAmount > 0">{{ upgradeInfo.current_experience + expAmount }} / {{ upgradeInfo.required_experience }}</span>
              </div>
            </div>
            <div class="gold-cost-preview" *ngIf="expAmount > 0 && levelUpResults.totalGoldCost > 0">
              <img src="/assets/game/gold_coin.png" alt="Gold" class="gold-icon" />
              <span>{{ levelUpResults.totalGoldCost | number }}</span>
            </div>
          </div>
        </div>

        <div class="character-stats">
          <div class="stat-item">
            <span class="stat-icon">ğŸ’ª</span>
            <span class="stat-value">{{ character.strength }}</span>
            <span class="stat-label">åŠ›é‡</span>
          </div>
          <div class="stat-item">
            <span class="stat-icon">âš¡</span>
            <span class="stat-value">{{ character.agility }}</span>
            <span class="stat-label">æ•æ·</span>
          </div>
          <div class="stat-item">
            <span class="stat-icon">ğŸ€</span>
            <span class="stat-value">{{ character.luck }}</span>
            <span class="stat-label">å¹¸é‹</span>
          </div>
        </div>

        <div class="character-skill">
          <h3>æŠ€èƒ½æè¿°</h3>
          <p>{{ character.skill_description }}</p>
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šå‡ç´šæ“ä½œ -->
    <div class="upgrade-panel">
      <!-- ç©å®¶è³‡æºé¡¯ç¤º -->
      <div class="resources-section">
        <h3>æ“æœ‰è³‡æº</h3>
        <div class="resource-grid">
          <div class="resource-item gold">
            <img src="/assets/game/gold_coin.png" alt="Gold" class="resource-icon" />
            <span class="resource-amount">{{ playerResources.gold | number }}</span>
            <span class="resource-label">é‡‘å¹£</span>
          </div>
          <div class="resource-item exp-potion">
            <img src="/assets/game/exp_potion.png" alt="Exp Potion" class="resource-icon" />
            <span class="resource-amount">{{ playerResources.exp_potion | number }}</span>
            <span class="resource-label">ç¶“é©—è—¥æ°´</span>
          </div>
          <div class="resource-item prompt">
            <img src="/assets/game/prompt.png" alt="PROMPT" class="resource-icon" />
            <span class="resource-amount">{{ playerResources.prompt | number }}</span>
            <span class="resource-label">$PROMPT</span>
          </div>
          <div class="resource-item prompt-power">
            <img src="/assets/game/prompt_power.png" alt="Prompt Power" class="resource-icon" />
            <span class="resource-amount">{{ playerResources.prompt_power | number }}</span>
            <span class="resource-label">Prompt Power</span>
          </div>
        </div>
      </div>


      <!-- å¢åŠ ç¶“é©—å€¼å€åŸŸ -->
      <div class="add-exp-section" *ngIf="!upgradeInfo.is_max_level">
        <h3>å¢åŠ ç¶“é©—å€¼</h3>
        <div class="exp-input-group">
          <div class="exp-amount-selector">
            <img src="/assets/game/exp_potion.png" alt="Exp Potion" class="exp-potion-icon" />
            <span class="selector-label">ä½¿ç”¨ç¶“é©—è—¥æ°´:</span>
            
            <div class="amount-controls">
              <button 
                (click)="decreaseExpAmount()" 
                class="control-button minus"
                [disabled]="expAmount <= 0"
              >
                âˆ’
              </button>
              
              <input 
                type="number" 
                [(ngModel)]="expAmount"
                (ngModelChange)="setExpAmount($event)"
                [min]="0" 
                [max]="maxExpAmount"
                class="exp-input"
              />
              
              <button 
                (click)="increaseExpAmount()" 
                class="control-button plus"
                [disabled]="expAmount >= maxExpAmount"
              >
                +
              </button>
            </div>
            
            <button 
              (click)="setMaxExpAmount()" 
              class="max-button"
              [disabled]="maxExpAmount === 0"
            >
              æœ€å¤§ ({{ maxExpAmount }})
            </button>
          </div>

          <button 
            (click)="upgradeCharacter()" 
            class="upgrade-button"
            [disabled]="isProcessing || expAmount <= 0 || expAmount > playerResources.exp_potion || (levelUpResults.totalGoldCost > 0 && !levelUpResults.canAfford)"
            [ngClass]="{ 'can-upgrade': expAmount > 0 && levelUpResults.canAfford }"
          >
            <span *ngIf="!isProcessing" class="button-content">
              <img src="/assets/game/exp_potion.png" alt="Exp Potion" class="button-icon" />
              <span *ngIf="expAmount > 0">æŠ•å…¥</span>
              <span *ngIf="expAmount <= 0">è«‹é¸æ“‡ç¶“é©—è—¥æ°´æ•¸é‡</span>
            </span>
            <span *ngIf="isProcessing">è™•ç†ä¸­...</span>
          </button>
        </div>
      </div>

      <!-- æ»¿ç´šé¡¯ç¤º -->
      <div class="max-level-section" *ngIf="upgradeInfo.is_max_level">
        <div class="max-level-display">
          <div class="max-level-icon">ğŸ‘‘</div>
          <h3>å·²é”æ»¿ç´š</h3>
          <p>æ­å–œï¼{{ character.name }} å·²ç¶“é”åˆ°æœ€é«˜ç­‰ç´š Lv.50</p>
          <p>ç¾åœ¨å¯ä»¥è€ƒæ…®å°‡è§’è‰²é‘„é€ æˆ NFT ä¾†æ°¸ä¹…ä¿å­˜ï¼</p>
        </div>
      </div>

    </div>
  </div>
</div>