<div *ngIf="isLoading" class="loading-overlay">
  <div class="magical-portal">
    <div class="magic-circle">
      <div class="inner-circle"></div>
      <div class="runes">‚ú¶ ‚úß ‚ú¶ ‚úß ‚ú¶ ‚úß</div>
    </div>
    <div class="energy-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
    <div class="overlay-text">
      <span class="text-glow">Ê≠£Âú®ËºâÂÖ•ÂÜíÈö™ËÄÖÊ™îÊ°à...</span>
      <div class="progress-dots">
        <span>‚óè</span><span>‚óè</span><span>‚óè</span>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!isLoading" class="game-profile-container">
  <div class="magical-background">
    <div class="floating-orbs">
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
      <div class="orb orb-3"></div>
    </div>
  </div>
  
  <!-- Case: No characters exist -->
  <div *ngIf="allCharacters.length === 0" class="empty-state">
    <div class="empty-portal">
      <div class="portal-ring"></div>
      <div class="portal-inner"></div>
      <div class="portal-icon">‚óâ</div>
    </div>
    <h2 class="empty-title">ÂÜíÈö™Â∞öÊú™ÈñãÂßã</h2>
    <p class="empty-text">Âè¨Âñö‰Ω†ÁöÑÁ¨¨‰∏Ä‰ΩçËã±ÈõÑÔºåÈñãÂïüÂÇ≥Â•á‰πãË∑Ø</p>
    <a routerLink="/create" class="game-button primary">
      <span class="button-icon">‚ú¶</span>
      ÂâµÂª∫Á¨¨‰∏Ä‰ΩçËã±ÈõÑ
    </a>
  </div>

  <!-- Case: Characters exist -->
  <div *ngIf="allCharacters.length > 0" class="profile-layout">
    <!-- Header Section -->
    <div class="profile-header-new">
      <div class="player-info-card">
        <div class="player-top">
          <div class="avatar-wrapper">
            <img src="/assets/icon_home.png" alt="avatar" />
            <div class="avatar-glow"></div>
          </div>
          <div class="player-details">
            <div class="nickname-display" *ngIf="!editNicknameMode">
              <h2 class="player-name">{{ displayName }}</h2>
              <button class="edit-icon-btn" *ngIf="!isViewMode" (click)="startEditNickname()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
            </div>
            <div class="nickname-edit" *ngIf="editNicknameMode">
              <input [(ngModel)]="nickname" maxlength="32" placeholder="Enter nickname" />
              <button (click)="saveNickname()" class="save-btn">Save</button>
              <button (click)="editNicknameMode=false" class="cancel-btn">‚úï</button>
            </div>
            <div class="wallet-address" *ngIf="walletAddress">
              <span class="wallet-icon">üîó</span>
              <span class="wallet-text">{{ walletAddress.slice(0, 6) }}...{{ walletAddress.slice(-4) }}</span>
            </div>
          </div>
        </div>
        <div class="onchain-actions" style="margin-top: 10px; display:flex; gap:10px; flex-wrap: wrap;">
          <a routerLink="/onchain-activity" class="game-button secondary">
            ON-CHAIN ACTIVITY
          </a>
          <button 
            *ngIf="currentCharacter && !isViewMode" 
            (click)="openShareDialog(currentCharacter)" 
            class="game-button share-button"
            style="background: linear-gradient(135deg, #ff3c6e, #ff6b9d);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
              <circle cx="18" cy="5" r="3"></circle>
              <circle cx="6" cy="12" r="3"></circle>
              <circle cx="18" cy="19" r="3"></circle>
              <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
              <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
            SHARE
          </button>
        </div>
        
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-icon">üë§</div>
            <div class="stat-content">
              <div class="stat-value">{{ totalCharacters }}</div>
              <div class="stat-label">Fighters</div>
            </div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-item">
            <div class="stat-icon">‚öîÔ∏è</div>
            <div class="stat-content">
              <div class="stat-value">{{ totalBattles }}</div>
              <div class="stat-label">Battles</div>
            </div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-item">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-content">
              <div class="stat-value">{{ overallWinRate }}%</div>
              <div class="stat-label">Win Rate</div>
            </div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-item legendary">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-content">
              <div class="stat-value">{{ getRarityCount(5) }}</div>
              <div class="stat-label">UR</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="highlight-fighter" *ngIf="currentCharacter">
        <div class="highlight-header">
          <span class="highlight-badge">TOP FIGHTER</span>
        </div>
        <div class="fighter-preview">
          <img [src]="currentCharacter.image_url" [alt]="currentCharacter.name" class="fighter-image" />
          <div class="fighter-info">
            <h3 class="fighter-name">{{ currentCharacter.name }}</h3>
            <div class="fighter-stats-mini">
              <span class="mini-stat">Lv.{{ currentCharacter.level }}</span>
              <span class="mini-stat rarity">{{ getRarityLabel(currentCharacter.rarity) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Character Collection -->
    <div class="character-collection">
      <div class="collection-header">
        <h2 class="collection-title">FIGHTERS</h2>
        <div class="collection-filters">
          <button 
            *ngFor="let filter of rarityFilters" 
            (click)="setRarityFilter(filter.value)"
            [class.active]="selectedRarityFilter === filter.value"
            class="filter-btn rarity-{{ filter.value }}">
            <span class="filter-text">{{ filter.label }}</span>
            <span class="filter-count">{{ getRarityCount(filter.value) }}</span>
          </button>
        </div>
      </div>
      
      <div class="heroes-grid">
        <!-- Character Cards -->
        <div *ngFor="let character of filteredCharacters" class="hero-card-wrapper">
          <div class="hero-card" (click)="selectCharacter(character)" 
               [class.selected]="character.id === currentCharacter?.id"
               [class.rarity-glow]="'rarity-' + character.rarity">
            <app-character-card [character]="character"></app-character-card>
            
            <!-- NFT ÂæΩÁ´†ÔºàÂè≥‰∏äËßíÔºâ -->
            <div class="nft-badge-corner" *ngIf="character.is_minted">
              <span class="nft-icon">‚úì</span>
              <span class="nft-text">ON-CHAIN</span>
            </div>
            
            <!-- Overlay: ÈÅ∏‰∏≠ÊôÇÈ°ØÁ§∫Âãï‰ΩúÊåâÈàï -->
            <div *ngIf="!isViewMode && character.id === currentCharacter?.id" class="action-overlay">
              
              <button class="action-btn battle-btn" (click)="$event.stopPropagation(); $event.preventDefault(); goToBattle()">
                BATTLE
              </button>
              <a 
                class="action-btn" 
                [routerLink]="['/onchain-activity']" 
                [queryParams]="{ characterId: character.id }"
                (click)="$event.stopPropagation();">
                ON-CHAIN HISTORY
              </a>
              <button 
                class="action-btn nft-btn" 
                *ngIf="!character.is_minted"
                [disabled]="isMinting && mintingCharacterId === character.id"
                (click)="mintNFT(character, $event)">
                <span *ngIf="!(isMinting && mintingCharacterId === character.id)">MINT NFT</span>
                <span *ngIf="isMinting && mintingCharacterId === character.id">MINTING...</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Create New Card -->
        <a routerLink="/create" class="create-hero-card">
          <div class="create-portal">
            <div class="create-ring"></div>
            <div class="create-plus">+</div>
          </div>
          <p class="create-text">Âè¨ÂñöÊñ∞Ëã±ÈõÑ</p>
        </a>
      </div>
    </div>
  </div>
  
  <!-- Share Dialog -->
  <app-share-dialog
    *ngIf="showShareDialog && shareCharacter"
    [character]="shareCharacter"
    [playerStats]="playerStatsForShare"
    (closed)="closeShareDialog()">
  </app-share-dialog>
</div> 